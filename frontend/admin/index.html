<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cidadão.AI - Administração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --transition-speed: 320ms;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .theme-modern {
            color-scheme: dark;
            --bg-body: #020617;
            --bg-surface: rgba(15, 23, 42, 0.85);
            --bg-surface-alt: rgba(15, 23, 42, 0.92);
            --bg-muted: rgba(30, 41, 59, 0.6);
            --border-soft: rgba(51, 65, 85, 0.6);
            --border-strong: rgba(56, 189, 248, 0.35);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #38bdf8;
            --accent-secondary: #a855f7;
            --shadow-highlight: 0 16px 45px rgba(56, 189, 248, 0.18);
            --header-gradient: linear-gradient(120deg, #0f172a 0%, #0b1120 45%, #111827 90%);
        }
        .theme-classic {
            color-scheme: light;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --bg-surface-alt: #f9fafb;
            --bg-muted: rgba(248, 250, 252, 0.8);
            --border-soft: rgba(148, 163, 184, 0.4);
            --border-strong: rgba(59, 130, 246, 0.6);
            --text-primary: #1e293b;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --accent-primary: #2563eb;
            --accent-secondary: #0ea5e9;
            --shadow-highlight: 0 10px 25px rgba(59, 130, 246, 0.15);
            --header-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 45%, #f1f5f9 100%);
        }
        .theme-dark {
            color-scheme: dark;
            --bg-body: #0b1120;
            --bg-surface: rgba(15, 23, 42, 0.9);
            --bg-surface-alt: rgba(15, 23, 42, 0.78);
            --bg-muted: rgba(30, 41, 59, 0.52);
            --border-soft: rgba(71, 85, 105, 0.72);
            --border-strong: rgba(96, 165, 250, 0.28);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5f5;
            --text-muted: #94a3b8;
            --accent-primary: #60a5fa;
            --accent-secondary: #34d399;
            --shadow-highlight: 0 18px 40px rgba(96, 165, 250, 0.18);
            --header-gradient: linear-gradient(125deg, #0b1120 0%, #1e293b 55%, #0b1120 100%);
        }
        body {
            background: var(--bg-body);
            color: var(--text-primary);
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .surface-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-soft);
            border-radius: 22px;
            transition: background var(--transition-speed), border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        .surface-card:hover {
            border-color: var(--border-strong);
            box-shadow: var(--shadow-highlight);
        }
        .surface-panel {
            background: var(--bg-surface-alt);
            border-radius: 26px;
            border: 1px solid var(--border-soft);
            transition: background var(--transition-speed), border-color var(--transition-speed);
        }
        .surface-chip {
            background: var(--bg-muted);
            border-radius: 999px;
            border: 1px solid transparent;
            transition: border-color var(--transition-speed), color var(--transition-speed);
        }
        .surface-chip:hover {
            border-color: var(--border-strong);
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            border-radius: 16px;
            color: var(--text-secondary);
            transition: background var(--transition-speed), color var(--transition-speed), border var(--transition-speed);
        }
        .sidebar-link i {
            width: 16px;
            text-align: center;
        }
        .sidebar-link.active,
        .sidebar-link:hover {
            color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.08);
            border-left: 3px solid var(--accent-primary);
        }
        .gov-badge {
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.12em;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.45);
            border-radius: 999px;
        }
        [x-cloak] { display: none !important; }
        body.theme-classic aside {
            background: #ffffff;
            border-right: 1px solid rgba(226, 232, 240, 0.85);
        }
        body.theme-classic aside .sidebar-link {
            color: #475569;
        }
        body.theme-classic aside .sidebar-link.active,
        body.theme-classic aside .sidebar-link:hover {
            background: rgba(37, 99, 235, 0.12);
            border-left-color: #2563eb;
            color: #2563eb;
        }
        body.theme-classic .surface-card,
        body.theme-classic .surface-panel {
            background: #ffffff;
            border-color: rgba(148, 163, 184, 0.45);
            color: #1e293b;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
        }
        body.theme-classic .surface-chip {
            background: #edf2f7;
            color: #1e293b;
            border-color: rgba(148, 163, 184, 0.35);
        }
        body.theme-classic .surface-chip:hover {
            border-color: rgba(37, 99, 235, 0.6);
        }
        body.theme-classic table tbody tr {
            background: #ffffff;
            color: #1f2937;
        }
        body.theme-classic table tbody tr:hover {
            background: #eff6ff;
        }
        body.theme-classic .input-surface {
            background: #ffffff;
            border-color: rgba(203, 213, 225, 0.8);
        }
    </style>
</head>
<body x-data="adminShell()" x-init="init()" :class="['theme-wrapper', theme]">
    <div class="flex min-h-screen">
        <aside class="hidden w-72 flex-shrink-0 flex-col border-r border-slate-800/40 bg-slate-950/60 px-6 py-6 backdrop-blur-xl transition-all duration-300 lg:flex" :class="theme === 'theme-classic' ? 'bg-white border-slate-200/80' : ''">
            <div class="flex items-center gap-4 pb-8">
                <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-sky-500/20 shadow-lg">
                    <i class="fas fa-landmark text-xl text-sky-400"></i>
                </div>
                <div>
                    <span class="gov-badge text-xs uppercase tracking-[0.35em] text-slate-400">GOVERNO MUNICIPAL</span>
                    <h1 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Cidadão.AI</h1>
                    <p class="text-xs text-slate-500" :class="theme === 'theme-classic' ? 'text-slate-400' : ''">Gestão integrada de chamados</p>
                </div>
            </div>
            <nav class="flex flex-1 flex-col gap-1">
                <button class="sidebar-link" :class="activeTab === 'dashboard' ? 'active' : ''" @click="selectTab('dashboard')">
                    <i class="fas fa-grid-2"></i>Visão Geral
                </button>
                <button class="sidebar-link" :class="activeTab === 'cidadaos' ? 'active' : ''" @click="selectTab('cidadaos')">
                    <i class="fas fa-id-card"></i>Cadastro de Cidadãos
                </button>
                <button class="sidebar-link" :class="activeTab === 'chamados' ? 'active' : ''" @click="selectTab('chamados')">
                    <i class="fas fa-ticket"></i>Chamados
                </button>
                <button class="sidebar-link" :class="activeTab === 'times' ? 'active' : ''" @click="selectTab('times')">
                    <i class="fas fa-users-gear"></i>Times
                </button>
                <button class="sidebar-link" :class="activeTab === 'agentes' ? 'active' : ''" @click="selectTab('agentes')">
                    <i class="fas fa-user-tie"></i>Agentes
                </button>
                <button class="sidebar-link" :class="activeTab === 'system' ? 'active' : ''" @click="selectTab('system')">
                    <i class="fas fa-cogs"></i>Sistema
                </button>
            </nav>
            <div class="mt-8 space-y-4">
                <div class="rounded-2xl border border-slate-700/60 p-4 text-sm" :class="theme === 'theme-classic' ? 'border-slate-200 bg-white shadow-sm' : ''">
                    <h3 class="mb-2 text-xs font-semibold uppercase tracking-widest text-slate-400">Atalhos</h3>
                    <ul class="space-y-2 text-slate-400">
                        <li><span class="font-medium text-slate-300" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Ctrl + K</span> – Command Palette</li>
                        <li><span class="font-medium text-slate-300" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">CTRL + /</span> – Assistente IA</li>
                        <li><span class="font-medium text-slate-300" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">F</span> – Filtrar Chamados</li>
                    </ul>
                </div>
            </div>
        </aside>

        <div class="flex flex-1 flex-col overflow-hidden">
            <header class="sticky top-0 z-30 border-b border-slate-800/20 bg-slate-950/60 backdrop-blur-xl transition-colors duration-300" :class="theme === 'theme-classic' ? 'bg-white/95 border-slate-200 shadow-sm' : ''">
                <div class="flex flex-col gap-3 px-4 py-5 sm:px-6 lg:flex-row lg:items-center lg:justify-between lg:gap-0">
                    <div class="flex items-center gap-4">
                        <button class="rounded-2xl border border-slate-800/60 bg-slate-950/40 px-3 py-2 text-sm text-slate-400 lg:hidden" @click="sidebarOpen = !sidebarOpen">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <p class="text-xs uppercase tracking-[0.45em] text-slate-500" :class="theme === 'theme-classic' ? 'text-slate-400' : ''">Painel de Controle</p>
                            <h2 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Prefeitura de Barreiras/BA</h2>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="inline-flex rounded-full border border-slate-700/60 bg-slate-950/30 p-1 text-xs font-semibold text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100/80 border-slate-200 text-slate-600' : ''">
                            <button class="rounded-full px-3 py-1" :class="theme === 'theme-modern' ? 'bg-sky-500/20 text-sky-200 border border-sky-400/60' : ''" @click="switchTheme('theme-modern')">Moderno</button>
                            <button class="rounded-full px-3 py-1" :class="theme === 'theme-classic' ? 'bg-sky-500/10 text-sky-700 border border-sky-400/50' : ''" @click="switchTheme('theme-classic')">Clássico</button>
                            <button class="rounded-full px-3 py-1" :class="theme === 'theme-dark' ? 'bg-sky-500/20 text-sky-100 border border-sky-400/60' : ''" @click="switchTheme('theme-dark')">Escuro</button>
                        </div>
                        <button class="inline-flex items-center gap-2 rounded-full border border-slate-700/60 bg-slate-950/40 px-4 py-2 text-sm text-slate-300 transition hover:text-sky-200" :class="theme === 'theme-classic' ? 'border-slate-200 bg-white text-slate-600 hover:text-sky-600' : ''" @click="openPalette = true">
                            <i class="fas fa-magnifying-glass"></i>Buscar
                        </button>
                        <button class="inline-flex items-center gap-2 rounded-full border border-slate-700/60 bg-slate-950/40 px-4 py-2 text-sm text-slate-300 transition hover:text-sky-200 xl:hidden" :class="theme === 'theme-classic' ? 'border-slate-200 bg-white text-slate-600 hover:text-sky-600' : ''" @click="showChatOnMobile = !showChatOnMobile">
                            <i class="fas fa-comments"></i>
                            <span x-text="showChatOnMobile ? 'Fechar Assistente' : 'Assistente IA'"></span>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto">
                <div class="mx-auto max-w-7xl space-y-6 px-4 py-6 sm:px-6 lg:px-8">
                    <template x-if="activeTab === 'dashboard'">
                        <section class="space-y-6">
                            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
                                <template x-for="card in metricCards" :key="card.id">
                                    <div class="surface-card p-6">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <p class="text-sm uppercase tracking-[0.25em] text-slate-500">{{ card.label }}</p>
                                                <h3 class="text-3xl font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''" x-text="card.value"></h3>
                                                <p class="mt-2 text-xs text-slate-500" x-text="card.caption"></p>
                                            </div>
                                            <span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-900/40 text-slate-300" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-500' : ''">
                                                <i :class="card.icon"></i>
                                            </span>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_28rem]">
                                <div class="surface-panel p-6">
                                    <div class="flex flex-col gap-4 border-b border-slate-700/40 pb-4 lg:flex-row lg:items-center lg:justify-between" :class="theme === 'theme-classic' ? 'border-slate-200/70' : ''">
                                        <div>
                                            <h3 class="text-base font-semibold" :class="theme === 'theme-classic' ? 'text-slate-700' : 'text-slate-100'">Monitoramento Operacional</h3>
                                            <p class="text-sm text-slate-500">Acompanhe os serviços críticos em tempo real</p>
                                        </div>
                                        <div class="inline-flex items-center gap-2 rounded-full border border-slate-700/60 bg-slate-950/40 px-3 py-1 text-xs text-slate-400" :class="theme === 'theme-classic' ? 'border-slate-200 bg-white text-slate-600' : ''">
                                            <span class="h-2 w-2 animate-pulse rounded-full bg-emerald-400"></span> Monitoramento ativo
                                        </div>
                                    </div>
                                    <div class="mt-5 grid gap-4 sm:grid-cols-2">
                                        <div class="surface-card p-4">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Banco de Dados</p>
                                                    <p class="mt-1 text-sm text-slate-400">Sincronização e integridade</p>
                                                </div>
                                                <div id="dashboard-db-pulse" class="relative h-10 w-10">
                                                    <span class="absolute inset-0 animate-ping rounded-full bg-emerald-500/30"></span>
                                                    <span class="relative flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
                                                        <i class="fas fa-database"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <span id="db-status" class="inline-flex items-center gap-2 rounded-full bg-slate-950/40 px-3 py-1 text-xs text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600' : ''">
                                                    Verificando...
                                                </span>
                                            </div>
                                        </div>
                                        <div class="surface-card p-4">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">IA Operacional</p>
                                                    <p class="mt-1 text-sm text-slate-400">Modelos e agentes conectados</p>
                                                </div>
                                                <div id="dashboard-ai-pulse" class="relative h-10 w-10">
                                                    <span class="absolute inset-0 animate-ping rounded-full bg-sky-500/30"></span>
                                                    <span class="relative flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/20 text-sky-200">
                                                        <i class="fas fa-robot"></i>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <span id="ai-status" class="inline-flex items-center gap-2 rounded-full bg-slate-950/40 px-3 py-1 text-xs text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600' : ''">
                                                    Verificando...
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="surface-panel p-6" x-data="chatPanel()" :class="showChatOnMobile ? '' : 'hidden xl:flex xl:flex-col'" x-on:assistente-sugestao.window="useSuggestion($event.detail.prompt, true)">
                                    <div class="flex items-center justify-between border-b border-slate-700/40 pb-4" :class="theme === 'theme-classic' ? 'border-slate-200/70' : ''">
                                        <div>
                                            <h3 class="text-base font-semibold" :class="theme === 'theme-classic' ? 'text-slate-700' : 'text-slate-100'">Assistente IA</h3>
                                            <p class="text-xs text-slate-500">Conselhos rápidos com base nos dados atuais</p>
                                        </div>
                                        <span class="surface-chip inline-flex items-center gap-2 px-3 py-1 text-xs text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600' : ''">
                                            <span class="h-1.5 w-1.5 animate-pulse rounded-full bg-emerald-400"></span> Online
                                        </span>
                                    </div>
                                    <div class="mt-4 flex-1 overflow-hidden rounded-2xl border border-slate-700/30" :class="theme === 'theme-classic' ? 'border-slate-200/70 bg-white/40' : 'bg-slate-950/40'">
                                        <div x-ref="scroll" class="flex h-80 flex-col gap-4 overflow-y-auto px-4 py-5">
                                            <template x-for="message in messages" :key="message.id">
                                                <div :class="message.role === 'assistant' ? 'mr-auto max-w-[82%]' : 'ml-auto max-w-[82%]'">
                                                    <div :class="message.role === 'assistant'
                                                            ? 'rounded-3xl border border-sky-500/30 bg-sky-500/10 px-4 py-3 text-sm text-sky-100 shadow-xl'
                                                            : 'rounded-3xl border border-slate-700/50 bg-slate-900/70 px-4 py-3 text-sm text-slate-200 shadow-lg'"
                                                         :class="theme === 'theme-classic' ? (message.role === 'assistant' ? 'bg-sky-50 border-sky-200 text-slate-700' : 'bg-slate-100 border-slate-200 text-slate-600') : ''">
                                                        <div class="flex items-center gap-2 text-xs uppercase tracking-[0.35em] text-slate-500">
                                                            <i :class="message.role === 'assistant' ? 'fas fa-robot text-sky-300' : 'fas fa-user text-slate-500'" :class="theme === 'theme-classic' ? 'text-slate-400' : ''"></i>
                                                            <span x-text="message.role === 'assistant' ? 'Assistente' : 'Você'"></span>
                                                            <span class="text-slate-600">·</span>
                                                            <span x-text="message.timestamp"></span>
                                                        </div>
                                                        <p class="mt-2 leading-relaxed" x-text="message.content" :class="theme === 'theme-classic' ? 'text-slate-600' : 'text-slate-100'"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <form class="mt-4 space-y-3" @submit.prevent="sendMessage">
                                        <div class="input-surface rounded-2xl px-4 py-3 focus-within:border-sky-500/60" :class="theme === 'theme-classic' ? 'border-slate-200 bg-white' : ''">
                                            <textarea x-model="draft" x-ref="input" rows="3" placeholder="Pergunte algo ao assistente ou use / para comandos" class="w-full resize-none bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none" :class="theme === 'theme-classic' ? 'text-slate-700' : ''"></textarea>
                                        </div>
                                        <div class="flex flex-wrap items-center justify-between gap-3">
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="suggestion in suggestions" :key="suggestion">
                                                    <button type="button" class="surface-chip rounded-full px-3 py-1 text-xs text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600 hover:border-slate-300' : ''" @click="useSuggestion(suggestion, false)">
                                                        <span x-text="suggestion"></span>
                                                    </button>
                                                </template>
                                            </div>
                                            <button type="submit" :disabled="sending" class="inline-flex items-center gap-2 rounded-full border border-sky-500/60 bg-sky-500/20 px-4 py-1.5 text-sm font-semibold text-sky-100 transition hover:border-sky-400 hover:bg-sky-500/30 disabled:cursor-not-allowed disabled:opacity-50" :class="theme === 'theme-classic' ? 'bg-sky-600 text-white border-sky-500 hover:bg-sky-500' : ''">
                                                <span x-show="!sending"><i class="fas fa-paper-plane"></i> Enviar</span>
                                                <span x-show="sending"><i class="fas fa-circle-notch animate-spin"></i> Enviando</span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </section>
                    </template>

                    <!-- Citizens Tab -->
                    <template x-if="activeTab === 'cidadaos'">
                        <section class="space-y-6">
                            <div class="surface-panel p-6">
                                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Cidadãos Cadastrados</h3>
                                        <p class="text-sm text-slate-500">Gerencie cadastros, endereços e dados de contato.
                                            <span class="ml-2 rounded-full bg-emerald-500/15 px-2.5 py-0.5 text-xs font-semibold text-emerald-300" :class="theme === 'theme-classic' ? 'bg-emerald-100 text-emerald-700' : ''">{{ citizens.length }} ativos</span>
                                        </p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button class="surface-chip inline-flex items-center gap-2 px-4 py-2 text-sm text-slate-300" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600 hover:border-slate-300' : ''" @click="loadCitadaos()">
                                            <i class="fas fa-rotate-right"></i> Atualizar
                                        </button>
                                        <button class="inline-flex items-center gap-2 rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100" :class="theme === 'theme-classic' ? 'bg-sky-600 text-white border-sky-500 hover:bg-sky-500' : ''" @click="openCitizenModal()">
                                            <i class="fas fa-user-plus"></i> Novo Cidadão
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-800/40" :class="theme === 'theme-classic' ? 'divide-slate-200' : ''">
                                        <thead class="bg-slate-900/60 text-xs uppercase tracking-wider text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-500' : ''">
                                            <tr>
                                                <th class="px-4 py-3 text-left">ID</th>
                                                <th class="px-4 py-3 text-left">Nome</th>
                                                <th class="px-4 py-3 text-left">CPF</th>
                                                <th class="px-4 py-3 text-left">Telefone</th>
                                                <th class="px-4 py-3 text-left">Email</th>
                                                <th class="px-4 py-3 text-left">Cadastrado em</th>
                                                <th class="px-4 py-3 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cidadaos-table" class="divide-y divide-slate-800/60"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </template>

                    <!-- Times Tab -->
                    <template x-if="activeTab === 'times'">
                        <section class="space-y-6">
                            <div class="surface-panel p-6">
                                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Times</h3>
                                        <p class="text-sm text-slate-500">Gerencie times responsáveis pelos chamados.</p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button class="surface-chip inline-flex items-center gap-2 px-4 py-2 text-sm text-slate-300" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600 hover:border-slate-300' : ''" @click="loadTimes()">
                                            <i class="fas fa-rotate-right"></i> Atualizar
                                        </button>
                                        <button class="inline-flex items-center gap-2 rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100" :class="theme === 'theme-classic' ? 'bg-sky-600 text-white border-sky-500 hover:bg-sky-500' : ''" @click="openTimeModal()">
                                            <i class="fas fa-plus"></i> Novo Time
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-800/40" :class="theme === 'theme-classic' ? 'divide-slate-200' : ''">
                                        <thead class="bg-slate-900/60 text-xs uppercase tracking-wider text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-500' : ''">
                                            <tr>
                                                <th class="px-4 py-3 text-left">ID</th>
                                                <th class="px-4 py-3 text-left">Nome</th>
                                                <th class="px-4 py-3 text-left">Cor</th>
                                                <th class="px-4 py-3 text-left">Responsável</th>
                                                <th class="px-4 py-3 text-left">Status</th>
                                                <th class="px-4 py-3 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-times-table" class="divide-y divide-slate-800/60"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </template>

                    <!-- Agentes Tab -->
                    <template x-if="activeTab === 'agentes'">
                        <section class="space-y-6">
                            <div class="surface-panel p-6">
                                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Agentes</h3>
                                        <p class="text-sm text-slate-500">Gerencie agentes humanos e IAs conectados ao Chatwoot.</p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button class="surface-chip inline-flex items-center gap-2 px-4 py-2 text-sm text-slate-300" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600 hover:border-slate-300' : ''" @click="loadAgentes()">
                                            <i class="fas fa-rotate-right"></i> Atualizar
                                        </button>
                                        <button class="inline-flex items-center gap-2 rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100" :class="theme === 'theme-classic' ? 'bg-sky-600 text-white border-sky-500 hover:bg-sky-500' : ''" @click="openAgenteModal()">
                                            <i class="fas fa-plus"></i> Novo Agente
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-800/40" :class="theme === 'theme-classic' ? 'divide-slate-200' : ''">
                                        <thead class="bg-slate-900/60 text-xs uppercase tracking-wider text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-500' : ''">
                                            <tr>
                                                <th class="px-4 py-3 text-left">ID</th>
                                                <th class="px-4 py-3 text-left">Nome</th>
                                                <th class="px-4 py-3 text-left">Tipo</th>
                                                <th class="px-4 py-3 text-left">Time</th>
                                                <th class="px-4 py-3 text-left">Email</th>
                                                <th class="px-4 py-3 text-left">Telefone</th>
                                                <th class="px-4 py-3 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-agentes-table" class="divide-y divide-slate-800/60"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </template>

                    <!-- System Tab -->
                    <template x-if="activeTab === 'system'">
                        <section class="space-y-6">
                            <div class="surface-panel p-6">
                                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-slate-100" :class="theme === 'theme-classic' ? 'text-slate-700' : ''">Status do Sistema</h3>
                                        <p class="text-sm text-slate-500">Resumo visual dos serviços críticos do ecossistema.</p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2">
                                        <button class="surface-chip inline-flex items-center gap-2 px-4 py-2 text-sm text-slate-300" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-600 hover:border-slate-300' : ''" @click="checkSystemStatus()">
                                            <i class="fas fa-sync"></i> Verificar Status
                                        </button>
                                        <button class="inline-flex items-center gap-2 rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100" :class="theme === 'theme-classic' ? 'bg-sky-600 text-white border-sky-500 hover:bg-sky-500' : ''" @click="openSystemModal()">
                                            <i class="fas fa-cogs"></i> Configurar Sistema
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-800/40" :class="theme === 'theme-classic' ? 'divide-slate-200' : ''">
                                        <thead class="bg-slate-900/60 text-xs uppercase tracking-wider text-slate-400" :class="theme === 'theme-classic' ? 'bg-slate-100 text-slate-500' : ''">
                                            <tr>
                                                <th class="px-4 py-3 text-left">Serviço</th>
                                                <th class="px-4 py-3 text-left">Status</th>
                                                <th class="px-4 py-3 text-left">Último Heartbeat</th>
                                                <th class="px-4 py-3 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="system-status-table" class="divide-y divide-slate-800/60"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </template>
                </div>
            </main>
        </div>
    </div>

    <div x-show="openPalette" x-cloak class="fixed inset-0 z-50 flex items-start justify-center bg-slate-950/80 px-4 pt-24 backdrop-blur-sm" @keydown.escape.window="openPalette = false">
        <div class="command-palette w-full max-w-2xl rounded-3xl p-6 shadow-glow">
            <div class="input-surface flex items-center gap-3 rounded-2xl px-4 py-3 focus-within:border-sky-500/60">
                <i class="fas fa-magnifying-glass text-slate-500"></i>
                <input type="text" x-model="commandQuery" placeholder="Buscar área, atalho ou comando..." class="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none">
                <span class="text-xs text-slate-600">Esc para sair</span>
            </div>
            <div class="mt-4 max-h-64 space-y-2 overflow-y-auto">
                <template x-for="item in paletteFiltered()" :key="item.label">
                    <button class="surface-chip flex w-full items-center justify-between rounded-xl px-4 py-3 text-sm text-slate-200 transition hover:border-sky-500/80 hover:text-sky-100" @click="item.action(); openPalette = false;">
                        <span x-text="item.label"></span>
                        <span class="text-xs text-slate-500" x-text="item.hint"></span>
                    </button>
                </template>
                <div x-show="paletteFiltered().length === 0" class="surface-panel rounded-xl px-4 py-6 text-center text-sm text-slate-500">
                    Nenhum comando encontrado para "<span x-text="commandQuery"></span>".
                </div>
            </div>
        </div>
    </div>

    <div id="modalTime" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 px-4 py-10 backdrop-blur-sm">
        <div class="surface-panel w-full max-w-xl rounded-3xl px-6 py-6 text-slate-100 shadow-glow">
            <div class="mb-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="timeFormTitle">Novo Time</h3>
                <button onclick="closeTimeModal()" class="surface-chip rounded-full px-3 py-1 text-xs text-slate-400">Fechar</button>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <input id="timeId" type="hidden">
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Nome</label>
                    <input id="timeNome" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome do time">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Cor</label>
                    <input id="timeCor" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none" value="#4ECDC4">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Chatwoot Team ID</label>
                    <input id="timeTeamId" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="ex: 12">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Responsável</label>
                    <input id="timeRespNome" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome do responsável">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">E-mail do Responsável</label>
                    <input id="timeRespEmail" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="email@dominio.com">
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Palavras-chave (separadas por vírgula)</label>
                    <input id="timeKeywords" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="buraco, iluminação, esgoto">
                </div>
                <div class="sm:col-span-2 flex items-center justify-between pt-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300">
                        <input id="timeActive" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900 accent-sky-500" checked>
                        Ativo
                    </label>
                    <div class="flex gap-2">
                        <button onclick="saveTime()" class="rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100 hover:border-sky-500 hover:bg-sky-500/30">Salvar</button>
                        <button onclick="closeTimeModal()" class="surface-chip rounded-full px-4 py-2 text-sm text-slate-300">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalAgente" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 px-4 py-10 backdrop-blur-sm">
        <div class="surface-panel w-full max-w-xl rounded-3xl px-6 py-6 text-slate-100 shadow-glow">
            <div class="mb-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="agenteFormTitle">Novo Agente</h3>
                <button onclick="closeAgenteModal()" class="surface-chip rounded-full px-3 py-1 text-xs text-slate-400">Fechar</button>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <input id="agenteId" type="hidden">
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Nome</label>
                    <input id="agenteNome" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome do agente">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Tipo</label>
                    <select id="agenteTipo" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none">
                        <option value="humano">Humano</option>
                        <option value="ia_geral">IA Geral</option>
                        <option value="ia_infraestrutura">IA Infraestrutura</option>
                        <option value="ia_saude">IA Saúde</option>
                        <option value="ia_educacao">IA Educação</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Chatwoot Agent ID</label>
                    <input id="agenteCwId" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="ex: 34">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">E-mail</label>
                    <input id="agenteEmail" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="email@dominio.com">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Telefone</label>
                    <input id="agenteTelefone" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="+55...">
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Times (selecione um ou mais)</label>
                    <select id="agenteTimeId" class="mt-1 h-40 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none" multiple size="5"></select>
                </div>
                <div class="sm:col-span-2 flex items-center justify-between pt-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300">
                        <input id="agenteActive" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900 accent-sky-500" checked>
                        Ativo
                    </label>
                    <div class="flex gap-2">
                        <button onclick="saveAgente()" class="rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100 hover:border-sky-500 hover:bg-sky-500/30">Salvar</button>
                        <button onclick="closeAgenteModal()" class="surface-chip rounded-full px-4 py-2 text-sm text-slate-300">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cidadão -->
    <div id="modalCitizen" class="fixed inset-0 z-40 hidden items-center justify-center bg-slate-950/80 px-4 py-10 backdrop-blur-sm">
        <div class="surface-panel w-full max-w-2xl rounded-3xl px-6 py-6 text-slate-100 shadow-glow">
            <div class="mb-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold" id="citizenFormTitle">Novo Cidadão</h3>
                <button onclick="closeCitizenModal()" class="surface-chip rounded-full px-3 py-1 text-xs text-slate-400">Fechar</button>
            </div>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <input id="citizenId" type="hidden">
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Nome Completo *</label>
                    <input id="citizenNome" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome completo do cidadão" required>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">CPF</label>
                    <input id="citizenCpf" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="000.000.000-00">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Telefone *</label>
                    <input id="citizenTelefone" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="+55 (00) 00000-0000" required>
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">E-mail</label>
                    <input id="citizenEmail" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="email@exemplo.com">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">CEP</label>
                    <div class="flex gap-2">
                        <input id="citizenCep" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="00000-000" maxlength="9">
                        <button type="button" class="surface-chip px-3 py-2 text-xs" onclick="lookupCep()">Buscar CEP</button>
                    </div>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Estado</label>
                    <input id="citizenEstado" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="UF" maxlength="2">
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Cidade</label>
                    <input id="citizenCidade" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome da cidade">
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Logradouro</label>
                    <input id="citizenLogradouro" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome da rua, avenida, etc.">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Número</label>
                    <input id="citizenNumero" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Número">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Bairro</label>
                    <input id="citizenBairro" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Nome do bairro">
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs uppercase tracking-wider text-slate-500">Complemento</label>
                    <input id="citizenComplemento" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-sky-500 focus:outline-none" placeholder="Complemento, referência, etc.">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Data de Nascimento</label>
                    <input id="citizenDataNascimento" type="date" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none">
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wider text-slate-500">Gênero</label>
                    <select id="citizenGenero" class="mt-1 w-full rounded-xl border border-slate-800 bg-slate-950 px-3 py-2 text-sm text-slate-100 focus:border-sky-500 focus:outline-none">
                        <option value="">Não informado</option>
                        <option value="masculino">Masculino</option>
                        <option value="feminino">Feminino</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="sm:col-span-2 flex items-center justify-between pt-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300">
                        <input id="citizenActive" type="checkbox" class="h-4 w-4 rounded border-slate-700 bg-slate-900 accent-sky-500" checked>
                        Ativo
                    </label>
                    <div class="flex gap-2">
                        <button onclick="saveCitizen()" class="rounded-full border border-sky-500/70 bg-sky-500/20 px-4 py-2 text-sm font-semibold text-sky-100 hover:border-sky-500 hover:bg-sky-500/30">Salvar</button>
                        <button onclick="closeCitizenModal()" class="surface-chip rounded-full px-4 py-2 text-sm text-slate-300">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminShell() {
            return {
                activeTab: 'cidadaos',
                openPalette: false,
                commandQuery: '',
                showChatOnMobile: false,
                theme: 'theme-modern',
                userThemeSet: false,
                metricCards: [
                    { id: 'citizens', label: 'Cidadãos', value: '-', caption: 'Registros ativos', icon: 'fas fa-users' },
                    { id: 'tickets', label: 'Chamados', value: '-', caption: 'Chamados totais', icon: 'fas fa-ticket-alt' },
                    { id: 'running', label: 'Em Andamento', value: '-', caption: 'Chamados em execução', icon: 'fas fa-clock' },
                    { id: 'solved', label: 'Resolvidos', value: '-', caption: 'Chamados resolvidos', icon: 'fas fa-circle-check' }
                ],
                init() {
                    this.initializeTheme();
                    const shortcutHandler = (event) => {
                        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
                            event.preventDefault();
                            this.openPalette = true;
                        }
                        if (event.shiftKey && event.key === '?') {
                            event.preventDefault();
                            this.openPalette = true;
                        }
                    };
                    window.addEventListener('keydown', shortcutHandler);
                    this.$watch('openPalette', (value) => {
                        if (!value) {
                            this.commandQuery = '';
                        }
                    });
                    window.addEventListener('resize', () => {
                        if (window.innerWidth >= 1280) {
                            this.showChatOnMobile = false;
                        }
                    });
                },
                initializeTheme() {
                    if (typeof window === 'undefined') return;
                    const stored = localStorage.getItem('adminTheme');
                    if (stored === 'theme-modern' || stored === 'theme-classic' || stored === 'theme-dark') {
                        this.theme = stored;
                        this.userThemeSet = true;
                    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: theme-light)').matches) {
                        this.theme = 'theme-classic';
                    }
                    this.applyTheme();
                    this.$watch('theme', (value) => {
                        this.applyTheme();
                        if (this.userThemeSet) {
                            localStorage.setItem('adminTheme', value);
                        }
                    });
                    this.attachSystemThemeListener();
                },
                applyTheme() {
                    if (typeof document !== 'undefined') {
                        document.documentElement.style.colorScheme = this.theme;
                    }
                },
                attachSystemThemeListener() {
                    if (!window.matchMedia) return;
                    const query = window.matchMedia('(prefers-color-scheme: theme-dark)');
                    const handler = (event) => {
                        if (!this.userThemeSet) {
                            this.theme = event.matches ? 'theme-dark' : 'theme-classic';
                        }
                    };
                    if (query.addEventListener) {
                        query.addEventListener('change', handler);
                    } else if (query.addListener) {
                        query.addListener(handler);
                    }
                },
                switchTheme(theme) {
                    this.userThemeSet = true;
                    this.theme = theme;
                },
                selectTab(tab) {
                    this.activeTab = tab;
                    if (tab === 'times') {
                        loadAdminTimes();
                    } else if (tab === 'agentes') {
                        loadAdminAgentes();
                    } else if (tab === 'chamados') {
                        loadChamados();
                    } else if (tab === 'cidadaos') {
                        loadCidadaos();
                    }
                },
                paletteActions() {
                    return [
                        { label: 'Ir para Cidadãos', hint: 'Enter', search: 'cidadaos cidadãos citizens', action: () => this.selectTab('cidadaos') },
                        { label: 'Ir para Chamados', hint: 'Enter', search: 'chamados chamados tickets', action: () => this.selectTab('chamados') },
                        { label: 'Ir para Times', hint: 'Enter', search: 'times squads equipes', action: () => this.selectTab('times') },
                        { label: 'Ir para Agentes', hint: 'Enter', search: 'agentes agents ia', action: () => this.selectTab('agentes') },
                        { label: 'Ver status do Sistema', hint: 'Enter', search: 'status sistema infraestrutura', action: () => this.selectTab('system') },
                        { label: 'Abrir assistente IA', hint: 'Ctrl+/', search: 'assistente chat ia', action: () => { this.showChatOnMobile = true; window.dispatchEvent(new CustomEvent('assistente-sugestao', { detail: { prompt: 'Quais são as principais prioridades agora?' } })); } }
                    ];
                },
                paletteFiltered() {
                    const query = this.commandQuery.trim().toLowerCase();
                    if (!query) {
                        return this.paletteActions();
                    }
                    return this.paletteActions().filter(item => item.search.includes(query) || item.label.toLowerCase().includes(query));
                }
            };
        }

        function chatPanel() {
            return {
                messages: [
                    {
                        id: Date.now(),
                        role: 'assistant',
                        content: 'Olá! Estou monitorando os chamados críticos e posso te ajudar com resumos, alertas e respostas automáticas. Como posso ajudar agora?',
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    }
                ],
                draft: '',
                sending: false,
                suggestions: [
                    'Quais chamados estão sem resposta há mais de 1 hora?',
                    'Há cidadãos esperando retorno da ouvidoria?',
                    'Algum serviço externo está instável?'
                ],
                useSuggestion(prompt, autoSend) {
                    this.draft = prompt;
                    this.$nextTick(() => {
                        this.$refs.input?.focus();
                        if (autoSend) {
                            this.sendMessage();
                        }
                    });
                },
                scrollToEnd() {
                    this.$nextTick(() => {
                        if (this.$refs.scroll) {
                            this.$refs.scroll.scrollTo({
                                top: this.$refs.scroll.scrollHeight,
                                behavior: 'smooth'
                            });
                        }
                    });
                },
                sendMessage() {
                    const content = (this.draft || '').trim();
                    if (!content || this.sending) {
                        return;
                    }
                    this.messages.push({
                        id: Date.now(),
                        role: 'user',
                        content,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    });
                    this.draft = '';
                    this.sending = true;
                    this.scrollToEnd();

                    setTimeout(() => {
                        this.appendAssistantResponse(content);
                    }, 600);
                },
                appendAssistantResponse() {
                    const insights = [
                        'Identifiquei 4 chamados críticos aguardando tratativa: iluminação pública (2), coleta de lixo (1) e pavimentação (1). Recomendo priorizar os que estão prestes a expirar SLA.',
                        'Sugiro enviar uma atualização automática aos cidadãos que aguardam resposta há mais de 40 minutos. Posso compor a mensagem com base no protocolo correspondente.',
                        'Nenhuma degradação encontrada nos serviços externos. Último heartbeat recebido há 2 minutos do provedor de IA.'
                    ];
                    const followUps = [
                        'Deseja que eu envie um resumo por e-mail aos responsáveis?',
                        'Posso abrir um ticket interno para o time responsável?',
                        'Quer que eu atualize o painel técnico com essas informações?'
                    ];
                    const response = `${insights[Math.floor(Math.random() * insights.length)]} ${followUps[Math.floor(Math.random() * followUps.length)]}`;

                    this.messages.push({
                        id: Date.now() + 1,
                        role: 'assistant',
                        content: response,
                        timestamp: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
                    });
                    this.sending = false;
                    this.scrollToEnd();
                }
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadMetrics();
            loadCidadaos();
            loadChamados();
            checkSystemStatus();
            
            setInterval(() => {
                loadMetrics();
                checkSystemStatus();
            }, 30000);

            window.loadAdminTimes = loadAdminTimes;
            window.loadAdminAgentes = loadAdminAgentes;
        });

        async function loadMetrics() {
            try {
                const response = await fetch('/api/chamados/metrics');
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('total-cidadaos').textContent = data.metrics.total_cidadaos || 0;
                    document.getElementById('total-chamados').textContent = data.metrics.total_chamados || 0;
                    document.getElementById('chamados-andamento').textContent = data.metrics.chamados_em_andamento || 0;
                    document.getElementById('chamados-resolvidos').textContent = data.metrics.chamados_resolvidos || 0;

                    const cardMap = {
                        citizens: data.metrics.total_cidadaos || 0,
                        tickets: data.metrics.total_chamados || 0,
                        running: data.metrics.chamados_em_andamento || 0,
                        solved: data.metrics.chamados_resolvidos || 0
                    };
                    this.metricCards = this.metricCards.map(card => ({
                        ...card,
                        value: cardMap[card.id] !== undefined ? cardMap[card.id] : card.value
                    }));
                }
            } catch (error) {
                console.error('Erro ao carregar métricas:', error);
            }
        }

        async function loadCidadaos() {
            try {
                const response = await fetch('/api/chamados/cidadaos');
                const data = await response.json();
                
                const tableBody = document.getElementById('cidadaos-table');
                
                if (data.status === 'success' && data.data.length > 0) {
                    tableBody.innerHTML = data.data.map(cidadao => `
                        <tr class="hover:bg-slate-900/60 transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${cidadao.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${cidadao.nome}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${cidadao.telefone}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${cidadao.email || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${new Date(cidadao.created_at).toLocaleString('pt-BR')}</td>
                            <td class="px-6 py-4 text-right">
                                <button class="text-sky-300 hover:text-sky-200" onclick="openCitizenModal(${cidadao.id})">Editar</button>
                                <button class="text-rose-300 hover:text-rose-200" onclick="deleteCitizen(${cidadao.id})">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-5 text-center text-sm text-slate-500">
                                Nenhum cidadão encontrado no período selecionado.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar cidadãos:', error);
                const tableBody = document.getElementById('cidadaos-table');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-5 text-center text-sm text-rose-400">
                            Erro ao carregar dados. Tente novamente.
                        </td>
                    </tr>
                `;
            }
        }

        async function loadChamados() {
            try {
                const response = await fetch('/api/chamados/chamados');
                const data = await response.json();
                
                const tableBody = document.getElementById('chamados-table');
                
                if (data.status === 'success' && data.data.length > 0) {
                    tableBody.innerHTML = data.data.map(chamado => {
                        const classes = chamado.status === 'resolvido'
                            ? 'border border-emerald-400/30 bg-emerald-500/10 text-emerald-200'
                            : chamado.status === 'em_andamento'
                                ? 'border border-amber-400/30 bg-amber-500/10 text-amber-200'
                                : 'border border-slate-700/60 bg-slate-900/80 text-slate-300';

                        return `
                            <tr class="hover:bg-slate-900/60 transition">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${chamado.protocolo}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-200">${chamado.titulo}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold ${classes}">
                                        <span class="h-1.5 w-1.5 rounded-full bg-current"></span>
                                    ${chamado.status}
                                </span>
                            </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${new Date(chamado.created_at).toLocaleString('pt-BR')}</td>
                                <td class="px-6 py-4 text-right">
                                    <button class="text-sky-300 hover:text-sky-200" onclick="openChamadoModal(${chamado.id})">Editar</button>
                                    <button class="text-rose-300 hover:text-rose-200" onclick="deleteChamado(${chamado.id})">Excluir</button>
                                </td>
                        </tr>
                        `;
                    }).join('');
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-5 text-center text-sm text-slate-500">
                                Nenhum chamado encontrado.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar chamados:', error);
                const tableBody = document.getElementById('chamados-table');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-5 text-center text-sm text-rose-400">
                            Erro ao carregar dados. Tente novamente.
                        </td>
                    </tr>
                `;
            }
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/chamados/status');
                const data = await response.json();
                
                const dbStatus = document.getElementById('db-status');
                const aiStatus = document.getElementById('ai-status');
                const dbStatusSystem = document.getElementById('db-status-system');
                const aiStatusSystem = document.getElementById('ai-status-system');
                
                if (data.database_connected) {
                    const html = '<span class="h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse"></span><span class="text-sm text-emerald-300">Conectado</span>';
                    dbStatus.innerHTML = html;
                    dbStatusSystem.textContent = 'Conectado';
                    dbStatusSystem.className = 'text-sm text-emerald-300';
                } else {
                    const html = '<span class="h-2.5 w-2.5 rounded-full bg-rose-400 animate-pulse"></span><span class="text-sm text-rose-300">Desconectado</span>';
                    dbStatus.innerHTML = html;
                    dbStatusSystem.textContent = 'Desconectado';
                    dbStatusSystem.className = 'text-sm text-rose-300';
                }
                
                if (data.chamados_ai_available) {
                    const html = '<span class="h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse"></span><span class="text-sm text-emerald-300">Disponível</span>';
                    aiStatus.innerHTML = html;
                    aiStatusSystem.textContent = 'Disponível';
                    aiStatusSystem.className = 'text-sm text-emerald-300';
                } else {
                    const html = '<span class="h-2.5 w-2.5 rounded-full bg-rose-400 animate-pulse"></span><span class="text-sm text-rose-300">Indisponível</span>';
                    aiStatus.innerHTML = html;
                    aiStatusSystem.textContent = 'Indisponível';
                    aiStatusSystem.className = 'text-sm text-rose-300';
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }

        async function loadAdminTimes() {
            try {
                const res = await fetch('/api/tecnico/times');
                const data = await res.json();
                const tb = document.getElementById('admin-times-table');
                if (!tb) return;
                tb.innerHTML = '';
                if (data.status === 'success') {
                    data.data.forEach(t => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-900/60 transition';
                        tr.innerHTML = `
                            <td class="px-6 py-4 text-sm text-slate-200">${t.nome}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-800/70" style="background:${t.cor}"></span>
                            </td>
                            <td class="px-6 py-4 text-sm text-slate-200">${t.responsavel_nome || '-'}</td>
                            <td class="px-6 py-4 text-sm text-slate-200">${t.active ? 'Ativo' : 'Inativo'}</td>
                            <td class="px-6 py-4 text-right text-sm">
                                <button class="mr-3 text-sky-300 hover:text-sky-200" onclick="openTimeModal(${t.id})">Editar</button>
                                <button class="text-rose-300 hover:text-rose-200" onclick="deleteTime(${t.id})">Excluir</button>
                            </td>
                        `;
                        tb.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar times:', error);
            }
        }

        async function loadAdminAgentes() {
            try {
                const res = await fetch('/api/tecnico/agentes');
                const data = await res.json();
                const tb = document.getElementById('admin-agentes-table');
                if (!tb) return;
                tb.innerHTML = '';
                if (data.status === 'success') {
                    data.data.forEach(a => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-900/60 transition';
                        tr.innerHTML = `
                            <td class="px-6 py-4 text-sm text-slate-200">${a.nome}</td>
                            <td class="px-6 py-4 text-sm text-slate-200">${a.tipo}</td>
                            <td class="px-6 py-4 text-sm text-slate-200">${a.time_nome || '-'}</td>
                            <td class="px-6 py-4 text-sm text-slate-200">${a.email || '-'}</td>
                            <td class="px-6 py-4 text-sm text-slate-200">${a.telefone || '-'}</td>
                            <td class="px-6 py-4 text-right text-sm">
                                <button class="mr-3 text-sky-300 hover:text-sky-200" onclick="openAgenteModal(${a.id})">Editar</button>
                                <button class="text-rose-300 hover:text-rose-200" onclick="deleteAgente(${a.id})">Excluir</button>
                            </td>
                        `;
                        tb.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar agentes:', error);
            }
        }
        
        function openTimeModal(id) {
            document.getElementById('timeFormTitle').innerText = id ? 'Editar Time' : 'Novo Time';
            const modal = document.getElementById('modalTime');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (id) {
                fetch('/api/tecnico/times').then(r => r.json()).then(d => {
                    const t = (d.data || []).find(x => x.id === id);
                    if (t) {
                        timeId.value = t.id;
                        timeNome.value = t.nome || '';
                        timeCor.value = t.cor || '#4ECDC4';
                        timeTeamId.value = t.chatwoot_team_id || '';
                        timeRespNome.value = t.responsavel_nome || '';
                        timeRespEmail.value = t.responsavel_email || '';
                        timeKeywords.value = (t.keywords || []).join(', ');
                        timeActive.checked = !!t.active;
                    }
                });
            } else {
                timeId.value = '';
                timeNome.value = '';
                timeCor.value = '#4ECDC4';
                timeTeamId.value = '';
                timeRespNome.value = '';
                timeRespEmail.value = '';
                timeKeywords.value = '';
                timeActive.checked = true;
            }
        }

        function closeTimeModal() {
            const modal = document.getElementById('modalTime');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveTime() {
            const payload = {
                nome: timeNome.value.trim(),
                chatwoot_team_id: timeTeamId.value ? Number(timeTeamId.value) : null,
                cor: timeCor.value.trim(),
                responsavel_nome: timeRespNome.value.trim() || null,
                responsavel_email: timeRespEmail.value.trim() || null,
                keywords: timeKeywords.value ? timeKeywords.value.split(',').map(s => s.trim()).filter(Boolean) : [],
                active: timeActive.checked
            };
            const id = timeId.value ? Number(timeId.value) : null;
            const url = id ? `/api/tecnico/times/${id}` : '/api/tecnico/times';
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            closeTimeModal();
            loadAdminTimes();
        }

        function deleteTime(id) {
            if (confirm('Excluir time?')) {
                fetch(`/api/tecnico/times/${id}`, { method: 'DELETE' }).then(() => loadAdminTimes());
            }
        }

        async function populateTimesSelect(selectedIds) {
            const sel = document.getElementById('agenteTimeId');
            sel.innerHTML = '';
            const res = await fetch('/api/tecnico/times');
            const data = await res.json();
            const selected = Array.isArray(selectedIds) ? selectedIds.map(Number) : (selectedIds ? [Number(selectedIds)] : []);
            (data.data || []).forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.nome;
                if (selected.includes(Number(t.id))) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function openAgenteModal(id) {
            document.getElementById('agenteFormTitle').innerText = id ? 'Editar Agente' : 'Novo Agente';
            const modal = document.getElementById('modalAgente');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (id) {
                fetch('/api/tecnico/agentes').then(r => r.json()).then(async d => {
                    const a = (d.data || []).find(x => x.id === id);
                    if (a) {
                        await populateTimesSelect(a.time_ids || a.time_id);
                        agenteId.value = a.id;
                        agenteNome.value = a.nome || '';
                        agenteTipo.value = a.tipo || 'humano';
                        agenteCwId.value = a.chatwoot_agent_id || '';
                        agenteEmail.value = a.email || '';
                        agenteTelefone.value = a.telefone || '';
                        agenteActive.checked = !!a.active;
                    }
                });
            } else {
                populateTimesSelect([]);
                agenteId.value = '';
                agenteNome.value = '';
                agenteTipo.value = 'humano';
                agenteCwId.value = '';
                agenteEmail.value = '';
                agenteTelefone.value = '';
                agenteActive.checked = true;
            }
        }

        function openCitizenModal(id) {
            document.getElementById('citizenFormTitle').innerText = id ? 'Editar Cidadão' : 'Novo Cidadão';
            const modal = document.getElementById('modalCitizen');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (id) {
                fetch('/api/chamados/cidadaos').then(r => r.json()).then(d => {
                    const c = (d.data || []).find(x => x.id === id);
                    if (c) {
                        citizenId.value = c.id;
                        citizenNome.value = c.nome || '';
                        citizenCpf.value = c.cpf || '';
                        citizenTelefone.value = c.telefone || '';
                        citizenEmail.value = c.email || '';
                        citizenCep.value = c.endereco?.cep || '';
                        citizenLogradouro.value = c.endereco?.logradouro || '';
                        citizenNumero.value = c.endereco?.numero || '';
                        citizenBairro.value = c.endereco?.bairro || '';
                        citizenCidade.value = c.endereco?.cidade || '';
                        citizenEstado.value = c.endereco?.estado || '';
                        citizenComplemento.value = c.endereco?.complemento || '';
                        citizenDataNascimento.value = c.data_nascimento || '';
                        citizenGenero.value = c.genero || '';
                        citizenActive.checked = !!c.active;
                    }
                });
            } else {
                citizenId.value = '';
                citizenNome.value = '';
                citizenCpf.value = '';
                citizenTelefone.value = '';
                citizenEmail.value = '';
                citizenCep.value = '';
                citizenLogradouro.value = '';
                citizenNumero.value = '';
                citizenBairro.value = '';
                citizenCidade.value = '';
                citizenEstado.value = '';
                citizenComplemento.value = '';
                citizenDataNascimento.value = '';
                citizenGenero.value = '';
                citizenActive.checked = true;
            }
        }

        function closeCitizenModal() {
            const modal = document.getElementById('modalCitizen');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function lookupCep() {
            const cep = citizenCep.value.replace(/\D/g, '');
            if (cep.length !== 8) {
                alert('Informe um CEP válido com 8 dígitos.');
                return;
            }
            try {
                const response = await fetch(`/api/utils/viacep/${cep}`);
                if (!response.ok) {
                    throw new Error('CEP não encontrado');
                }
                const dados = await response.json();
                citizenLogradouro.value = dados.logradouro || '';
                citizenBairro.value = dados.bairro || '';
                citizenCidade.value = dados.localidade || '';
                citizenEstado.value = dados.uf || '';
            } catch (error) {
                alert('Não foi possível buscar o CEP informado.');
                console.error('Erro ao buscar CEP:', error);
            }
        }

        async function saveCitizen() {
            const payload = {
                nome: citizenNome.value.trim(),
                cpf: citizenCpf.value.trim() || null,
                telefone: citizenTelefone.value.trim(),
                email: citizenEmail.value.trim() || null,
                cep: citizenCep.value.trim() || null,
                endereco: citizenLogradouro.value.trim() || null,
                numero: citizenNumero.value.trim() || null,
                bairro: citizenBairro.value.trim() || null,
                cidade: citizenCidade.value.trim() || null,
                estado: citizenEstado.value.trim() || null,
                complemento: citizenComplemento.value.trim() || null,
                data_nascimento: citizenDataNascimento.value.trim() || null,
                genero: citizenGenero.value.trim() || null,
                active: citizenActive.checked
            };

            const id = citizenId.value ? Number(citizenId.value) : null;
            const url = id ? `/api/chamados/cidadaos/${id}` : '/api/chamados/cidadaos';
            const method = id ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await resp.json();
                if (json.status === 'error') {
                    alert(json.message || 'Erro ao salvar');
                    return;
                }
                closeCitizenModal();
                loadCidadaos();
            } catch (error) {
                alert('Erro ao salvar cidadão');
                console.error(error);
            }
        }

        function deleteCitizen(id) {
            if (confirm('Excluir cidadão?')) {
                fetch(`/api/chamados/cidadaos/${id}`, { method: 'DELETE' }).then(() => loadCidadaos());
            }
        }

        function closeAgenteModal() {
            const modal = document.getElementById('modalAgente');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function saveAgente() {
            const selTimes = document.getElementById('agenteTimeId');
            const timeVals = Array.from(selTimes.selectedOptions).map(o => Number(o.value));
            if (!timeVals.length) {
                alert('Selecione pelo menos um time.');
                return;
            }
            const payload = {
                nome: agenteNome.value.trim(),
                tipo: agenteTipo.value,
                chatwoot_agent_id: agenteCwId.value ? Number(agenteCwId.value) : null,
                email: agenteEmail.value.trim() || null,
                telefone: agenteTelefone.value.trim() || null,
                active: agenteActive.checked,
                time_ids: timeVals
            };
            const id = agenteId.value ? Number(agenteId.value) : null;
            const url = id ? `/api/tecnico/agentes/${id}` : '/api/tecnico/agentes';
            const method = id ? 'PUT' : 'POST';
            const resp = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const json = await resp.json().catch(() => ({}));
            if (json && json.status === 'error') {
                alert(json.message || 'Erro ao salvar');
                return;
            }
            closeAgenteModal();
            loadAdminAgentes();
        }

        function deleteAgente(id) {
            if (confirm('Excluir agente?')) {
                fetch(`/api/tecnico/agentes/${id}`, { method: 'DELETE' }).then(() => loadAdminAgentes());
            }
        }
    </script>
</body>
</html>
