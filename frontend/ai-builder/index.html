<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cidad√£o.AI - Construtor de Agentes IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen" x-data="aiBuilder()">
        <!-- Header -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-robot text-2xl text-blue-600 mr-3"></i>
                        <h1 class="text-xl font-bold text-gray-800">Cidad√£o.AI - Construtor de Agentes</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="showAnalytics()" 
                                class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                            <i class="fas fa-chart-line mr-2"></i>
                            Analytics
                        </button>
                        <button @click="runTestSuite()" 
                                class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700">
                            <i class="fas fa-vial mr-2"></i>
                            Suite de Testes
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Sidebar - Configura√ß√µes -->
                <div class="lg:col-span-1">
                    <div class="bg-white shadow rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <i class="fas fa-cog mr-2"></i>Configura√ß√µes do Agente
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Agente</label>
                                <input type="text" x-model="agentConfig.name" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Agente de Infraestrutura">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Provedor de IA</label>
                                <select x-model="agentConfig.provider" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="groq">Groq (Llama 3.1)</option>
                                    <option value="openai">OpenAI (GPT-4)</option>
                                    <option value="anthropic">Anthropic (Claude)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                <select x-model="agentConfig.category" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="infraestrutura">Infraestrutura</option>
                                    <option value="saude">Sa√∫de</option>
                                    <option value="educacao">Educa√ß√£o</option>
                                    <option value="assistencia_social">Assist√™ncia Social</option>
                                    <option value="vendas">Vendas</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">SLA (horas)</label>
                                <input type="number" x-model="agentConfig.sla" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label>
                                <select x-model="agentConfig.priority" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Cr√≠tica</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white shadow rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <i class="fas fa-file-alt mr-2"></i>Templates de Resposta
                        </h3>
                        
                        <div class="space-y-2">
                            <button @click="addTemplate('boas_vindas')" 
                                    class="w-full text-left p-2 bg-blue-50 hover:bg-blue-100 rounded flex items-center">
                                <i class="fas fa-hand-wave mr-2"></i>Boas-vindas
                            </button>
                            <button @click="addTemplate('coleta_dados')" 
                                    class="w-full text-left p-2 bg-green-50 hover:bg-green-100 rounded flex items-center">
                                <i class="fas fa-user mr-2"></i>Coleta de Dados
                            </button>
                            <button @click="addTemplate('confirmacao')" 
                                    class="w-full text-left p-2 bg-yellow-50 hover:bg-yellow-100 rounded flex items-center">
                                <i class="fas fa-check mr-2"></i>Confirma√ß√£o
                            </button>
                            <button @click="addTemplate('protocolo')" 
                                    class="w-full text-left p-2 bg-purple-50 hover:bg-purple-100 rounded flex items-center">
                                <i class="fas fa-badge-check mr-2"></i>Gera√ß√£o de Protocolo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="lg:col-span-2">
                    <div class="bg-white shadow rounded-lg">
                        <!-- Tabs -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex">
                                <button @click="activeTab = 'prompt'" 
                                        :class="activeTab === 'prompt' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                        class="py-2 px-1 border-b-2 font-medium text-sm">
                                    <i class="fas fa-edit mr-2"></i>Prompt Principal
                                </button>
                                <button @click="activeTab = 'flow'" 
                                        :class="activeTab === 'flow' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                        class="py-2 px-1 border-b-2 font-medium text-sm ml-8">
                                    <i class="fas fa-sitemap mr-2"></i>Fluxo
                                </button>
                                <button @click="activeTab = 'test'" 
                                        :class="activeTab === 'test' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                        class="py-2 px-1 border-b-2 font-medium text-sm ml-8">
                                    <i class="fas fa-flask mr-2"></i>Teste
                                </button>
                            </nav>
                        </div>

                        <div class="p-6">
                            <!-- Tab: Prompt Principal -->
                            <div x-show="activeTab === 'prompt'">
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700">
                                            Prompt do Sistema
                                        </label>
                                        <div class="flex space-x-2">
                                            <button @click="loadTemplate('infraestrutura')" 
                                                    class="px-3 py-1 bg-blue-100 text-blue-700 text-xs rounded hover:bg-blue-200">
                                                Infraestrutura
                                            </button>
                                            <button @click="loadTemplate('saude')" 
                                                    class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded hover:bg-green-200">
                                                Sa√∫de
                                            </button>
                                            <button @click="loadTemplate('educacao')" 
                                                    class="px-3 py-1 bg-purple-100 text-purple-700 text-xs rounded hover:bg-purple-200">
                                                Educa√ß√£o
                                            </button>
                                        </div>
                                    </div>
                                    <textarea 
                                        x-model="agentConfig.systemPrompt"
                                        rows="12" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Voc√™ √© um assistente especializado em...">
                                    </textarea>
                                </div>

                                <!-- Configura√ß√µes Avan√ßadas -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Temperatura: <span x-text="agentConfig.temperature"></span>
                                        </label>
                                        <input type="range" x-model="agentConfig.temperature" min="0" max="2" step="0.1"
                                               class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Max Tokens</label>
                                        <input type="number" x-model="agentConfig.maxTokens" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>

                                <!-- Bot√µes de A√ß√£o Principais -->
                                <div class="flex justify-center space-x-4 mb-6">
                                    <button @click="saveAgent()" 
                                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                                            :disabled="saving">
                                        <i class="fas fa-save"></i>
                                        <span x-text="saving ? 'Salvando...' : 'Salvar Agente'"></span>
                                    </button>
                                    <button @click="testAgent()" 
                                            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center space-x-2"
                                            :disabled="testing">
                                        <i class="fas fa-play"></i>
                                        <span x-text="testing ? 'Testando...' : 'Testar Agente'"></span>
                                    </button>
                                    <button @click="deployAgent()" 
                                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 flex items-center space-x-2"
                                            :disabled="deploying">
                                        <i class="fas fa-rocket"></i>
                                        <span x-text="deploying ? 'Deploying...' : 'Deploy/Ativar'"></span>
                                    </button>
                                </div>

                                <!-- Status do Agente -->
                                <div x-show="currentAgentId" class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                        <span class="text-green-800 font-medium">
                                            Agente ID: <span x-text="currentAgentId"></span> - Pronto para uso!
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Fluxo -->
                            <div x-show="activeTab === 'flow'" class="text-center py-12">
                                <i class="fas fa-sitemap text-6xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Editor de Fluxo</h3>
                                <p class="text-gray-500">Em desenvolvimento - Visualiza√ß√£o do fluxo de conversa</p>
                            </div>

                            <!-- Tab: Teste -->
                            <div x-show="activeTab === 'test'">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Simulador de Conversa -->
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-900 mb-4">
                                            <i class="fas fa-comments mr-2"></i>Simulador de Conversa
                                        </h4>
                                        
                                        <!-- M√©tricas -->
                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div class="bg-blue-100 p-3 rounded-lg text-center">
                                                <div class="text-sm text-blue-600">Tempo</div>
                                                <div class="font-bold text-blue-900" x-text="testMetrics.responseTime || 'N/A'"></div>
                                            </div>
                                            <div class="bg-green-100 p-3 rounded-lg text-center">
                                                <div class="text-sm text-green-600">Tokens</div>
                                                <div class="font-bold text-green-900" x-text="testMetrics.tokensUsed || 'N/A'"></div>
                                            </div>
                                            <div class="bg-purple-100 p-3 rounded-lg text-center">
                                                <div class="text-sm text-purple-600">Custo</div>
                                                <div class="font-bold text-purple-900" x-text="testMetrics.estimatedCost || 'N/A'"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Input de teste -->
                                        <div class="flex space-x-2 mb-4">
                                            <input type="text" x-model="testMessage"
                                                   placeholder="Digite sua mensagem..."
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <button @click="sendTestMessage()" 
                                                    class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                                    :disabled="sendingMessage">
                                                <i class="fas fa-paper-plane"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Conversa de Teste -->
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-900 mb-4">
                                            <i class="fas fa-history mr-2"></i>Conversa de Teste
                                        </h4>
                                        
                                        <div class="bg-gray-50 rounded-lg p-4 h-64 overflow-y-auto">
                                            <div class="space-y-3">
                                                <template x-for="(message, index) in testConversation" :key="index">
                                                    <div :class="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                                        <div :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'" 
                                                             class="p-3 rounded-lg max-w-xs">
                                                            <span x-text="message.message"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <div x-show="testConversation.length === 0" class="text-center text-gray-500 py-8">
                                                    <i class="fas fa-comments text-2xl mb-2"></i>
                                                    <p>Inicie uma conversa de teste</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function aiBuilder() {
            return {
                // Estado da aplica√ß√£o
                activeTab: 'prompt',
                currentAgentId: null,
                
                // Configura√ß√£o do agente
                agentConfig: {
                    name: 'Agente de Infraestrutura',
                    provider: 'groq',
                    category: 'infraestrutura',
                    sla: 24,
                    priority: 'alta',
                    systemPrompt: `Voc√™ √© um assistente especializado em atendimento ao cidad√£o para problemas de infraestrutura urbana.

SUAS RESPONSABILIDADES:
- Coletar dados do cidad√£o de forma amig√°vel
- Categorizar problemas de infraestrutura
- Gerar protocolos √∫nicos
- Fornecer informa√ß√µes sobre prazos

CATEGORIAS DE INFRAESTRUTURA:
- Buracos nas ruas
- Problemas de ilumina√ß√£o p√∫blica
- Vazamentos de √°gua
- Danos em cal√ßadas
- Problemas de drenagem

SEMPRE:
- Seja educado e prestativo
- Confirme informa√ß√µes importantes
- Explique os pr√≥ximos passos
- Forne√ßa o protocolo gerado`,
                    temperature: 0.7,
                    maxTokens: 1000
                },
                
                // Estados de controle
                saving: false,
                testing: false,
                deploying: false,
                sendingMessage: false,
                
                // Dados de teste
                testMessage: 'Ol√°, preciso de ajuda com um buraco na rua',
                testMetrics: {},
                testConversation: [],
                
                // Inicializa√ß√£o
                init() {
                    // Garantir que testConversation seja um array
                    if (!Array.isArray(this.testConversation)) {
                        this.testConversation = [];
                    }
                },
                
                // Templates dispon√≠veis
                templates: {
                    infraestrutura: {
                        name: "Agente de Infraestrutura",
                        systemPrompt: `Voc√™ √© um assistente especializado em atendimento ao cidad√£o para problemas de infraestrutura urbana.

SUAS RESPONSABILIDADES:
- Coletar dados do cidad√£o de forma amig√°vel
- Categorizar problemas de infraestrutura
- Gerar protocolos √∫nicos
- Fornecer informa√ß√µes sobre prazos

CATEGORIAS DE INFRAESTRUTURA:
- Buracos nas ruas
- Problemas de ilumina√ß√£o p√∫blica
- Vazamentos de √°gua
- Danos em cal√ßadas
- Problemas de drenagem

SEMPRE:
- Seja educado e prestativo
- Confirme informa√ß√µes importantes
- Explique os pr√≥ximos passos
- Forne√ßa o protocolo gerado`,
                        sla: 24,
                        priority: 'alta'
                    },
                    saude: {
                        name: "Agente de Sa√∫de",
                        systemPrompt: `Voc√™ √© um assistente especializado em atendimento ao cidad√£o para quest√µes de sa√∫de p√∫blica.

SUAS RESPONSABILIDADES:
- Coletar dados do cidad√£o
- Categorizar problemas de sa√∫de
- Priorizar casos urgentes
- Fornecer orienta√ß√µes b√°sicas

CATEGORIAS DE SA√öDE:
- Agendamento de consultas
- Problemas em unidades de sa√∫de
- Emerg√™ncias m√©dicas
- Vacina√ß√£o
- Programas de sa√∫de

SEMPRE:
- Seja emp√°tico e profissional
- Priorize casos urgentes
- Forne√ßa informa√ß√µes claras
- Oriente sobre procedimentos`,
                        sla: 4,
                        priority: 'critica'
                    },
                    educacao: {
                        name: "Agente de Educa√ß√£o",
                        systemPrompt: `Voc√™ √© um assistente especializado em atendimento ao cidad√£o para quest√µes de educa√ß√£o municipal.

SUAS RESPONSABILIDADES:
- Orientar sobre matr√≠culas escolares
- Informar sobre transporte escolar
- Resolver quest√µes de merenda
- Fornecer informa√ß√µes sobre programas educacionais

CATEGORIAS DE EDUCA√á√ÉO:
- Matr√≠culas escolares
- Transporte escolar
- Merenda escolar
- Material did√°tico
- Programas educacionais

SEMPRE:
- Seja paciente e educativo
- Forne√ßa informa√ß√µes claras sobre prazos
- Oriente sobre documentos necess√°rios
- Explique procedimentos passo a passo`,
                        sla: 48,
                        priority: 'media'
                    }
                },
                
                // M√©todos
                loadTemplate(templateKey) {
                    const template = this.templates[templateKey];
                    if (template) {
                        this.agentConfig.name = template.name;
                        this.agentConfig.systemPrompt = template.systemPrompt;
                        this.agentConfig.sla = template.sla;
                        this.agentConfig.priority = template.priority;
                        this.agentConfig.category = templateKey;
                        
                        alert(`‚úÖ Template "${template.name}" carregado com sucesso!`);
                    }
                },
                
                async saveAgent() {
                    this.saving = true;
                    try {
                        const response = await fetch('/api/ai-builder/agents', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.agentConfig)
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            this.currentAgentId = result.agent.id;
                            alert('‚úÖ Agente salvo com sucesso!');
                            console.log('Agente criado:', result.agent);
                        } else {
                            alert('‚ùå Erro ao salvar: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao salvar agente:', error);
                        alert('‚ùå Erro de conex√£o ao salvar agente');
                    } finally {
                        this.saving = false;
                    }
                },
                
                async testAgent() {
                    this.testing = true;
                    try {
                        const response = await fetch('/api/ai-builder/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                config: this.agentConfig,
                                message: this.testMessage
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            this.testMetrics = {
                                responseTime: result.metrics.response_time.toFixed(2) + 's',
                                tokensUsed: result.metrics.tokens_used,
                                estimatedCost: '$' + result.metrics.estimated_cost.toFixed(4)
                            };
                            
                            // Adicionar √† conversa de teste
                            this.testConversation.push({
                                role: 'user',
                                message: this.testMessage
                            });
                            this.testConversation.push({
                                role: 'assistant',
                                message: result.response
                            });
                            
                            alert('‚úÖ Teste realizado com sucesso!');
                        } else {
                            alert('‚ùå Erro no teste: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao testar agente:', error);
                        alert('‚ùå Erro de conex√£o ao testar agente');
                    } finally {
                        this.testing = false;
                    }
                },
                
                async sendTestMessage() {
                    if (!this.testMessage.trim()) return;
                    
                    this.sendingMessage = true;
                    try {
                        const response = await fetch('/api/ai-builder/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                config: this.agentConfig,
                                message: this.testMessage
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            // Adicionar √† conversa
                            this.testConversation.push({
                                role: 'user',
                                message: this.testMessage
                            });
                            this.testConversation.push({
                                role: 'assistant',
                                message: result.response
                            });
                            
                            // Atualizar m√©tricas
                            this.testMetrics = {
                                responseTime: result.metrics.response_time.toFixed(2) + 's',
                                tokensUsed: result.metrics.tokens_used,
                                estimatedCost: '$' + result.metrics.estimated_cost.toFixed(4)
                            };
                            
                            // Limpar input
                            this.testMessage = '';
                        } else {
                            alert('‚ùå Erro: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao enviar mensagem:', error);
                        alert('‚ùå Erro de conex√£o');
                    } finally {
                        this.sendingMessage = false;
                    }
                },
                
                async deployAgent() {
                    if (!this.currentAgentId) {
                        alert('‚ùå Salve o agente primeiro!');
                        return;
                    }
                    
                    this.deploying = true;
                    try {
                        const response = await fetch(`/api/ai-builder/agents/${this.currentAgentId}/activate`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            alert('üöÄ Agente ativado com sucesso! Agora est√° respondendo no WhatsApp!');
                        } else {
                            alert('‚ùå Erro ao ativar: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao ativar agente:', error);
                        alert('‚ùå Erro de conex√£o ao ativar agente');
                    } finally {
                        this.deploying = false;
                    }
                },
                
                addTemplate(type) {
                    const templates = {
                        boas_vindas: `Ol√°! Sou o assistente da prefeitura para {categoria}. Como posso te ajudar hoje?`,
                        coleta_dados: `Para criar seu chamado, preciso de algumas informa√ß√µes:\n\n1. Nome completo\n2. Telefone\n3. Endere√ßo do problema\n4. Descri√ß√£o detalhada\n\nPode me informar seu nome?`,
                        confirmacao: `Perfeito! Confirme se os dados est√£o corretos:\n\nNome: {nome}\nTelefone: {telefone}\nEndere√ßo: {endereco}\n\nProblema: {problema}\n\nEst√° tudo certo?`,
                        protocolo: `‚úÖ Seu chamado foi criado com sucesso!\n\nüìã Protocolo: {protocolo}\nüìÖ Prazo: {prazo}\nüè¢ Categoria: {categoria}\n\nVoc√™ pode consultar o status a qualquer momento usando este protocolo.`
                    };
                    
                    this.agentConfig.systemPrompt += `\n\n--- TEMPLATE ${type.toUpperCase()} ---\n${templates[type]}`;
                },
                
                async showAnalytics() {
                    if (!this.currentAgentId) {
                        alert('‚ùå Nenhum agente selecionado');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/ai-builder/analytics/${this.currentAgentId}?days=30`);
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            this.displayAnalytics(result.analytics);
                        } else {
                            alert('‚ùå Erro ao carregar analytics: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar analytics:', error);
                        alert('‚ùå Erro de conex√£o ao carregar analytics');
                    }
                },
                
                displayAnalytics(analytics) {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üìä Analytics do Agente</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-800">Total de Intera√ß√µes</h4>
                                    <p class="text-2xl font-bold text-blue-900">${analytics.overview.total_interactions || 0}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800">Taxa de Sucesso</h4>
                                    <p class="text-2xl font-bold text-green-900">${((analytics.overview.successful_interactions || 0) / (analytics.overview.total_interactions || 1) * 100).toFixed(1)}%</p>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-purple-800">Tempo M√©dio</h4>
                                    <p class="text-2xl font-bold text-purple-900">${(analytics.overview.avg_response_time || 0).toFixed(2)}s</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">üìà Performance por Dia</h4>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${analytics.daily_performance.map(day => `
                                            <div class="flex justify-between text-sm">
                                                <span>${new Date(day.date).toLocaleDateString('pt-BR')}</span>
                                                <span>${day.interactions} intera√ß√µes</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">üè∑Ô∏è Categorias</h4>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${analytics.categories.map(cat => `
                                            <div class="flex justify-between text-sm">
                                                <span>${cat.category || 'N√£o categorizado'}</span>
                                                <span>${cat.count} vezes</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                },
                
                async runTestSuite() {
                    if (!this.currentAgentId) {
                        alert('‚ùå Nenhum agente selecionado');
                        return;
                    }
                    
                    const testCases = [
                        { message: "Ol√°, preciso de ajuda", expected: "greeting" },
                        { message: "Tem um buraco na rua da minha casa", expected: "infrastructure" },
                        { message: "Quero agendar uma consulta m√©dica", expected: "health" },
                        { message: "Como fa√ßo para matricular meu filho na escola?", expected: "education" }
                    ];
                    
                    try {
                        const response = await fetch(`/api/ai-builder/agents/${this.currentAgentId}/test-suite`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ test_cases: testCases })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            this.displayTestResults(result.test_results);
                        } else {
                            alert('‚ùå Erro ao executar testes: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Erro ao executar testes:', error);
                        alert('‚ùå Erro de conex√£o ao executar testes');
                    }
                },
                
                displayTestResults(results) {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üß™ Resultados dos Testes</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-blue-800">Total de Testes</h4>
                                    <p class="text-2xl font-bold text-blue-900">${results.total_tests}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-green-800">Testes Aprovados</h4>
                                    <p class="text-2xl font-bold text-green-900">${results.passed_tests}</p>
                                </div>
                                <div class="bg-red-100 p-4 rounded-lg">
                                    <h4 class="font-semibold text-red-800">Taxa de Sucesso</h4>
                                    <p class="text-2xl font-bold text-red-900">${results.success_rate.toFixed(1)}%</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <h4 class="font-semibold">üìã Detalhes dos Testes</h4>
                                ${results.results.map((test, index) => `
                                    <div class="border rounded-lg p-4 ${test.passed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-medium">Teste ${index + 1}</span>
                                            <span class="px-2 py-1 rounded text-xs ${test.passed ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                                ${test.passed ? '‚úÖ Aprovado' : '‚ùå Falhou'}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2"><strong>Mensagem:</strong> ${test.test_case.message}</p>
                                        <p class="text-sm text-gray-600"><strong>Resposta:</strong> ${test.result.response || 'Erro na resposta'}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            }
        }
    </script>
</body>
</html>
