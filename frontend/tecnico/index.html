<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cidadão.AI - Painel Técnico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 120px);
        }
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-comments text-2xl"></i>
                <h1 class="text-xl font-bold">Cidadão.AI - Painel Técnico</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-sm">Online</span>
                </div>
                <a href="#" id="navTimes" class="text-white hover:underline text-sm"><i class="fas fa-users mr-1"></i>Times</a>
                <a href="#" id="navAgentes" class="text-white hover:underline text-sm"><i class="fas fa-user-gear mr-1"></i>Agentes</a>
                <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex h-screen" id="pageConversations">
        <!-- Sidebar - Lista de Conversas -->
        <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Conversas Ativas</h2>
                <div class="mt-2">
                    <input type="text" id="searchInput" placeholder="Buscar conversas..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div id="conversationsList" class="flex-1 overflow-y-auto">
                <!-- Conversas serão carregadas aqui -->
                <div class="p-4 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Carregando conversas...</p>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div id="chatHeader" class="bg-white border-b border-gray-200 p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <h3 id="contactName" class="font-semibold text-gray-800"></h3>
                            <p id="contactPhone" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span id="conversationStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-700"></span>
                        <button id="closeChatBtn" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesContainer" class="flex-1 chat-container overflow-y-auto p-4 bg-gray-50">
                <div class="text-center text-gray-500 mt-20">
                    <i class="fas fa-comments text-4xl mb-4"></i>
                    <p class="text-lg">Selecione uma conversa para começar</p>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator px-4 py-2 bg-gray-100">
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-sm text-gray-500">Digitando...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div id="messageInput" class="bg-white border-t border-gray-200 p-4 hidden">
                <div class="flex items-center space-x-3">
                    <button id="recordBtn" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200" title="Gravar áudio">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="imageBtn" class="p-3 bg-gray-100 rounded-lg hover:bg-gray-200" title="Enviar imagem" onclick="uploadImage()">
                        <i class="fas fa-image"></i>
                    </button>
                    <div class="flex-1">
                        <textarea id="messageText" placeholder="Digite sua mensagem..." 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                  rows="1"></textarea>
                    </div>
                    <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <!-- Fallback upload de arquivo de áudio -->
                    <input id="audioFile" type="file" accept="audio/*" class="hidden" />
                </div>
            </div>
        </div>
    </div>

    <!-- Página Times -->
    <div class="hidden p-4" id="pageTimes">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800"><i class="fas fa-users mr-2"></i>Times</h2>
            <button id="btnNovoTime" class="bg-blue-600 text-white px-3 py-2 rounded"><i class="fas fa-plus mr-1"></i>Novo Time</button>
        </div>
        <div class="bg-white rounded shadow">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Nome</th>
                        <th class="px-4 py-2">Cor</th>
                        <th class="px-4 py-2">Responsável</th>
                        <th class="px-4 py-2">Status</th>
                        <th class="px-4 py-2 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody id="tblTimesBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Página Agentes -->
    <div class="hidden p-4" id="pageAgentes">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800"><i class="fas fa-user-gear mr-2"></i>Agentes</h2>
            <button id="btnNovoAgente" class="bg-blue-600 text-white px-3 py-2 rounded"><i class="fas fa-plus mr-1"></i>Novo Agente</button>
        </div>
        <div class="bg-white rounded shadow">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Nome</th>
                        <th class="px-4 py-2">Tipo</th>
                        <th class="px-4 py-2">E-mail</th>
                        <th class="px-4 py-2">Telefone</th>
                        <th class="px-4 py-2">Status</th>
                        <th class="px-4 py-2 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody id="tblAgentesBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Time -->
    <div id="modalTime" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
        <div class="bg-white rounded p-4 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3" id="timeFormTitle">Novo Time</h3>
            <div class="grid grid-cols-2 gap-3">
                <input id="timeId" type="hidden">
                <div class="col-span-2">
                    <label class="text-xs text-gray-600">Nome</label>
                    <input id="timeNome" class="w-full border px-3 py-2 rounded" placeholder="Nome do time">
                </div>
                <div>
                    <label class="text-xs text-gray-600">Cor</label>
                    <input id="timeCor" class="w-full border px-3 py-2 rounded" value="#4ECDC4">
                </div>
                <div>
                    <label class="text-xs text-gray-600">Chatwoot Team ID</label>
                    <input id="timeTeamId" class="w-full border px-3 py-2 rounded" placeholder="ex: 12">
                </div>
                <div>
                    <label class="text-xs text-gray-600">Responsável</label>
                    <input id="timeRespNome" class="w-full border px-3 py-2 rounded" placeholder="Nome do responsável">
                </div>
                <div>
                    <label class="text-xs text-gray-600">E-mail do Responsável</label>
                    <input id="timeRespEmail" class="w-full border px-3 py-2 rounded" placeholder="email@dominio.com">
                </div>
                <div class="col-span-2">
                    <label class="text-xs text-gray-600">Palavras-chave (separadas por vírgula)</label>
                    <input id="timeKeywords" class="w-full border px-3 py-2 rounded" placeholder="buraco, iluminação, esgoto">
                </div>
                <div class="col-span-2 flex items-center justify-between mt-2">
                    <label class="text-sm"><input id="timeActive" type="checkbox" class="mr-2" checked> Ativo</label>
                    <div class="space-x-2">
                        <button onclick="saveTime()" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
                        <button onclick="closeTimeModal()" class="bg-gray-200 px-3 py-2 rounded">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agente -->
    <div id="modalAgente" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
        <div class="bg-white rounded p-4 w-full max-w-lg">
            <h3 class="text-lg font-semibold mb-3" id="agenteFormTitle">Novo Agente</h3>
            <div class="grid grid-cols-2 gap-3">
                <input id="agenteId" type="hidden">
                <div class="col-span-2">
                    <label class="text-xs text-gray-600">Nome</label>
                    <input id="agenteNome" class="w-full border px-3 py-2 rounded" placeholder="Nome do agente">
                </div>
                <div>
                    <label class="text-xs text-gray-600">Tipo</label>
                    <select id="agenteTipo" class="w-full border px-3 py-2 rounded">
                        <option value="humano">Humano</option>
                        <option value="ia_geral">IA Geral</option>
                        <option value="ia_infraestrutura">IA Infraestrutura</option>
                        <option value="ia_saude">IA Saúde</option>
                        <option value="ia_educacao">IA Educação</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-gray-600">Chatwoot Agent ID</label>
                    <input id="agenteCwId" class="w-full border px-3 py-2 rounded" placeholder="ex: 34">
                </div>
                <div>
                    <label class="text-xs text-gray-600">E-mail</label>
                    <input id="agenteEmail" class="w-full border px-3 py-2 rounded" placeholder="email@dominio.com">
                </div>
                <div>
                    <label class="text-xs text-gray-600">Telefone</label>
                    <input id="agenteTelefone" class="w-full border px-3 py-2 rounded" placeholder="+55...">
                </div>
                <div class="col-span-2">
                    <label class="text-xs text-gray-600">Times (selecione um ou mais)</label>
                    <select id="agenteTimeIds" class="w-full border px-3 py-2 rounded" multiple size="5"></select>
                </div>
                <div class="col-span-2 flex items-center justify-between mt-2">
                    <label class="text-sm"><input id="agenteActive" type="checkbox" class="mr-2" checked> Ativo</label>
                    <div class="space-x-2">
                        <button onclick="saveAgente()" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
                        <button onclick="closeAgenteModal()" class="bg-gray-200 px-3 py-2 rounded">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navegação simples entre páginas
        const pageConversations = document.getElementById('pageConversations');
        const pageTimes = document.getElementById('pageTimes');
        const pageAgentes = document.getElementById('pageAgentes');
        function showPage(page) {
            [pageConversations, pageTimes, pageAgentes].forEach(p => p.classList.add('hidden'));
            page.classList.remove('hidden');
        }
        document.getElementById('navTimes').addEventListener('click', (e)=>{ e.preventDefault(); showPage(pageTimes); loadTimes(); });
        document.getElementById('navAgentes').addEventListener('click', (e)=>{ e.preventDefault(); showPage(pageAgentes); loadAgentes(); });

        // Carregar Times
        async function loadTimes(){
            const res = await fetch('/api/tecnico/times');
            const data = await res.json();
            const tbody = document.getElementById('tblTimesBody');
            tbody.innerHTML='';
            if(data.status==='success'){
                data.data.forEach(t=>{
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2">${t.nome}</td>
                        <td class="px-4 py-2"><span class="inline-block w-4 h-4 rounded" style="background:${t.cor}"></span></td>
                        <td class="px-4 py-2">${t.responsavel_nome || '-'}</td>
                        <td class="px-4 py-2">${t.active ? 'Ativo' : 'Inativo'}</td>
                        <td class="px-4 py-2 text-right">
                            <button class="text-blue-600 hover:underline mr-2" onclick="openTimeModal(${t.id})">Editar</button>
                            <button class="text-red-600 hover:underline" onclick="deleteTime(${t.id})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // Carregar Agentes
        async function loadAgentes(){
            const res = await fetch('/api/tecnico/agentes');
            const data = await res.json();
            const tbody = document.getElementById('tblAgentesBody');
            tbody.innerHTML='';
            if(data.status==='success'){
                data.data.forEach(a=>{
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-2">${a.nome}</td>
                        <td class="px-4 py-2">${a.tipo}</td>
                        <td class="px-4 py-2">${a.email || '-'}</td>
                        <td class="px-4 py-2">${a.telefone || '-'}</td>
                        <td class="px-4 py-2">${a.active ? 'Ativo' : 'Inativo'}</td>
                        <td class="px-4 py-2 text-right">
                            <button class="text-blue-600 hover:underline mr-2" onclick="openAgenteModal(${a.id})">Editar</button>
                            <button class="text-red-600 hover:underline" onclick="deleteAgente(${a.id})">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        // Modal handlers wired up
        document.getElementById('btnNovoTime').addEventListener('click', ()=> openTimeModal());
        document.getElementById('btnNovoAgente').addEventListener('click', ()=> openAgenteModal());

        // --------- Funções Modal Time ---------
        function openTimeModal(id){
            document.getElementById('timeFormTitle').innerText = id ? 'Editar Time' : 'Novo Time';
            const modal = document.getElementById('modalTime');
            if(id){
                fetch('/api/tecnico/times').then(r=>r.json()).then(d=>{
                    const t = (d.data||[]).find(x=>x.id===id);
                    if(t){
                        timeId.value = t.id;
                        timeNome.value = t.nome||'';
                        timeCor.value = t.cor||'#4ECDC4';
                        timeTeamId.value = t.chatwoot_team_id||'';
                        timeRespNome.value = t.responsavel_nome||'';
                        timeRespEmail.value = t.responsavel_email||'';
                        timeKeywords.value = (t.keywords||[]).join(', ');
                        timeActive.checked = !!t.active;
                        modal.classList.remove('hidden');
                    }
                });
            } else {
                timeId.value = '';
                timeNome.value = '';
                timeCor.value = '#4ECDC4';
                timeTeamId.value = '';
                timeRespNome.value = '';
                timeRespEmail.value = '';
                timeKeywords.value = '';
                timeActive.checked = true;
                modal.classList.remove('hidden');
            }
        }
        function closeTimeModal(){ document.getElementById('modalTime').classList.add('hidden'); }
        async function saveTime(){
            const payload = {
                nome: timeNome.value.trim(),
                chatwoot_team_id: timeTeamId.value? Number(timeTeamId.value): null,
                cor: timeCor.value.trim(),
                responsavel_nome: timeRespNome.value.trim()||null,
                responsavel_email: timeRespEmail.value.trim()||null,
                keywords: timeKeywords.value? timeKeywords.value.split(',').map(s=>s.trim()).filter(Boolean):[],
                active: timeActive.checked
            };
            const id = timeId.value? Number(timeId.value): null;
            const url = id? `/api/tecnico/times/${id}` : '/api/tecnico/times';
            const method = id? 'PUT' : 'POST';
            await fetch(url,{method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            closeTimeModal();
            loadTimes();
        }
        async function deleteTime(id){
            if(!confirm('Excluir este time?')) return;
            await fetch(`/api/tecnico/times/${id}`,{method:'DELETE'});
            loadTimes();
        }

        // --------- Funções Modal Agente ---------
        async function populateTimesSelectTecnico(selectedIds){
            const sel = document.getElementById('agenteTimeIds');
            sel.innerHTML='';
            const res = await fetch('/api/tecnico/times');
            const data = await res.json();
            const selected = Array.isArray(selectedIds) ? selectedIds.map(Number) : (selectedIds? [Number(selectedIds)]: []);
            (data.data||[]).forEach(t=>{
                const opt = document.createElement('option');
                opt.value = t.id; opt.textContent = t.nome;
                if(selected.includes(Number(t.id))) opt.selected=true;
                sel.appendChild(opt);
            });
        }

        function openAgenteModal(id){
            document.getElementById('agenteFormTitle').innerText = id ? 'Editar Agente' : 'Novo Agente';
            const modal = document.getElementById('modalAgente');
            if(id){
                fetch('/api/tecnico/agentes').then(r=>r.json()).then(d=>{
                    const a = (d.data||[]).find(x=>x.id===id);
                    if(a){
                        populateTimesSelectTecnico(a.time_ids || a.time_id);
                        agenteId.value = a.id;
                        agenteNome.value = a.nome||'';
                        agenteTipo.value = a.tipo||'humano';
                        agenteCwId.value = a.chatwoot_agent_id||'';
                        agenteEmail.value = a.email||'';
                        agenteTelefone.value = a.telefone||'';
                        agenteActive.checked = !!a.active;
                        modal.classList.remove('hidden');
                    }
                });
            } else {
                populateTimesSelectTecnico([]);
                agenteId.value = '';
                agenteNome.value='';
                agenteTipo.value='humano';
                agenteCwId.value='';
                agenteEmail.value='';
                agenteTelefone.value='';
                agenteActive.checked=true;
                modal.classList.remove('hidden');
            }
        }
        function closeAgenteModal(){ document.getElementById('modalAgente').classList.add('hidden'); }
        async function saveAgente(){
            const sel = document.getElementById('agenteTimeIds');
            const timeVals = Array.from(sel.selectedOptions).map(o=>Number(o.value));
            if(!timeVals.length){ alert('Selecione pelo menos um time.'); return; }
            const payload = {
                nome: agenteNome.value.trim(),
                tipo: agenteTipo.value,
                chatwoot_agent_id: agenteCwId.value? Number(agenteCwId.value): null,
                email: agenteEmail.value.trim()||null,
                telefone: agenteTelefone.value.trim()||null,
                active: agenteActive.checked,
                time_ids: timeVals
            };
            const id = agenteId.value? Number(agenteId.value): null;
            const url = id? `/api/tecnico/agentes/${id}` : '/api/tecnico/agentes';
            const method = id? 'PUT' : 'POST';
            await fetch(url,{method, headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            closeAgenteModal();
            loadAgentes();
        }
        async function deleteAgente(id){
            if(!confirm('Excluir este agente?')) return;
            await fetch(`/api/tecnico/agentes/${id}`,{method:'DELETE'});
            loadAgentes();
        }
    </script>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center space-x-3">
                <i class="fas fa-spinner fa-spin text-blue-600"></i>
                <span>Carregando...</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="/static/js/config.js"></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Inicialização -->
    <script>
        // Garantir que Socket.IO está carregado
        if (typeof io === 'undefined') {
            console.error('❌ Socket.IO não carregado!');
        } else {
            console.log('✅ Socket.IO carregado com sucesso');
        }
    </script>
</body>
</html>
